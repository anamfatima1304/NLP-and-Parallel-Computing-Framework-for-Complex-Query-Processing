<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NLP & Parallel Query Processing System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üöÄ NLP & Parallel Computing Framework</h1>
            <p class="subtitle">Complex Query Processing with Parallel Execution</p>
        </header>

        <!-- Dataset Info -->
        <div class="info-panel" id="datasetInfo">
            <h3>üìä Dataset Information</h3>
            <div id="datasetDetails">Loading...</div>
        </div>

        <!-- Query Input Section -->
        <div class="query-section">
            <h2>Enter Your Query</h2>
            
            <div class="input-group">
                <label for="queryInput">Natural Language Query:</label>
                <textarea id="queryInput" 
                          placeholder="e.g., Show me total sales by region for 2023"
                          rows="3"></textarea>
            </div>

            <div class="input-group">
                <label for="numProcesses">Number of Parallel Processes:</label>
                <input type="number" id="numProcesses" value="4" min="1" max="16">
                <span class="help-text">Available CPU cores: <span id="cpuCores">4</span></span>
            </div>

            <div class="button-group">
                <button onclick="processQuery()" class="btn btn-primary">
                    üîç Process Query
                </button>
                <button onclick="clearResults()" class="btn btn-secondary">
                    üóëÔ∏è Clear
                </button>
            </div>
        </div>

        <!-- Example Queries -->
        <div class="examples-section">
            <h3>üìù Example Queries</h3>
            <div id="exampleQueries">Loading...</div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Processing your query...</p>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" style="display: none;">
            
            <!-- Query Decomposition -->
            <div class="result-panel">
                <h2>1Ô∏è‚É£ Query Decomposition</h2>
                <div id="decompositionResult"></div>
            </div>

            <!-- Execution Plan -->
            <div class="result-panel">
                <h2>2Ô∏è‚É£ Execution Plan (DAG)</h2>
                <div id="executionPlan"></div>
            </div>

            <!-- Performance Metrics -->
            <div class="result-panel">
                <h2>3Ô∏è‚É£ Performance Metrics</h2>
                <div id="performanceMetrics"></div>
            </div>

            <!-- Final Results -->
            <div class="result-panel">
                <h2>4Ô∏è‚É£ Query Results</h2>
                <div id="finalResults"></div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>¬© 2024 NLP & Parallel Computing Framework | Academic Project</p>
        </footer>
    </div>

    <script>
        // Load dataset info on page load
        window.onload = function() {
            loadDatasetInfo();
            loadExampleQueries();
        };

        function loadDatasetInfo() {
            fetch('/api/dataset_info')
                .then(response => response.json())
                .then(data => {
                    const html = `
                        <div class="info-grid">
                            <div class="info-item">
                                <strong>Total Records:</strong> ${data.total_records.toLocaleString()}
                            </div>
                            <div class="info-item">
                                <strong>Date Range:</strong> ${data.date_range.min_year} - ${data.date_range.max_year}
                            </div>
                            <div class="info-item">
                                <strong>Products:</strong> ${data.unique_values.products}
                            </div>
                            <div class="info-item">
                                <strong>Regions:</strong> ${data.unique_values.regions}
                            </div>
                            <div class="info-item">
                                <strong>Total Revenue:</strong> $${(data.financial_summary.total_revenue).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                            </div>
                            <div class="info-item">
                                <strong>Avg Transaction:</strong> $${(data.financial_summary.avg_transaction).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                            </div>
                        </div>
                    `;
                    document.getElementById('datasetDetails').innerHTML = html;
                })
                .catch(error => {
                    document.getElementById('datasetDetails').innerHTML = '<p class="error">Failed to load dataset info</p>';
                });
        }

        function loadExampleQueries() {
            fetch('/api/example_queries')
                .then(response => response.json())
                .then(examples => {
                    const html = examples.map(ex => `
                        <div class="example-query" onclick="setQuery('${ex.query}')">
                            <div class="example-text">${ex.query}</div>
                            <div class="example-desc">${ex.description}</div>
                        </div>
                    `).join('');
                    document.getElementById('exampleQueries').innerHTML = html;
                })
                .catch(error => {
                    document.getElementById('exampleQueries').innerHTML = '<p class="error">Failed to load examples</p>';
                });
        }

        function setQuery(query) {
            document.getElementById('queryInput').value = query;
        }

        function processQuery() {
            const query = document.getElementById('queryInput').value.trim();
            const numProcesses = parseInt(document.getElementById('numProcesses').value);

            if (!query) {
                alert('Please enter a query');
                return;
            }

            // Show loading
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';

            // Make API call
            fetch('/api/process_query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    query: query,
                    num_processes: numProcesses
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                displayResults(data);
            })
            .catch(error => {
                alert('Error: ' + error.message);
            })
            .finally(() => {
                document.getElementById('loadingIndicator').style.display = 'none';
            });
        }

        function displayResults(data) {
            // Show results section
            document.getElementById('resultsSection').style.display = 'block';

            // 1. Display Decomposition
            const decomp = data.decomposition;
            let decompHtml = `
                <div class="decomp-info">
                    <p><strong>Original Query:</strong> ${decomp.original_query}</p>
                    <p><strong>Detected Intents:</strong> ${decomp.intents.join(', ')}</p>
                    <p><strong>Total Tasks:</strong> ${decomp.total_tasks}</p>
                </div>
                <h4>Sub-Tasks:</h4>
                <div class="tasks-list">
            `;
            decomp.tasks.forEach(task => {
                decompHtml += `
                    <div class="task-card">
                        <div class="task-id">${task.task_id}</div>
                        <div class="task-op">${task.operation}</div>
                        <div class="task-details">${JSON.stringify(task, null, 2).replace(/</, '&lt;').replace(/>/, '&gt;')}</div>
                    </div>
                `;
            });
            decompHtml += '</div>';
            document.getElementById('decompositionResult').innerHTML = decompHtml;

            // 2. Display Execution Plan
            const plan = data.execution_plan;
            let planHtml = `
                <div class="plan-info">
                    <p><strong>Total Layers:</strong> ${plan.total_layers}</p>
                    <p><strong>Max Parallelism:</strong> ${plan.max_parallelism} tasks</p>
                </div>
                <pre class="dag-viz">${data.dag_visualization}</pre>
            `;
            document.getElementById('executionPlan').innerHTML = planHtml;

            // 3. Display Performance Metrics
            const metrics = data.execution_metadata;
            let metricsHtml = `
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">${metrics.total_execution_time}s</div>
                        <div class="metric-label">Total Execution Time</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${metrics.num_processes_used}</div>
                        <div class="metric-label">Processes Used</div>
                    </div>
                </div>
                <h4>Task Execution Times:</h4>
                <div class="task-times">
            `;
            for (const [taskId, time] of Object.entries(metrics.task_execution_times)) {
                metricsHtml += `<div class="task-time"><span>${taskId}:</span> <span>${time}s</span></div>`;
            }
            metricsHtml += '</div>';
            document.getElementById('performanceMetrics').innerHTML = metricsHtml;

            // 4. Display Final Results
            const result = data.result;
            let resultHtml = '';

            if (result.type === 'dataframe') {
                resultHtml += `
                    <div class="result-summary">
                        <p><strong>Result Type:</strong> Table</p>
                        <p><strong>Total Rows:</strong> ${result.shape.rows}</p>
                        <p><strong>Columns:</strong> ${result.shape.columns}</p>
                    </div>
                    <div class="table-container">
                        <table class="result-table">
                            <thead>
                                <tr>${result.columns.map(col => `<th>${col}</th>`).join('')}</tr>
                            </thead>
                            <tbody>
                                ${result.data.map(row => `
                                    <tr>${result.columns.map(col => `<td>${typeof row[col] === 'number' ? row[col].toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) : row[col]}</td>`).join('')}</tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                if (result.statistics) {
                    resultHtml += '<h4>Statistics:</h4><div class="stats-grid">';
                    for (const [col, stats] of Object.entries(result.statistics)) {
                        resultHtml += `
                            <div class="stat-card">
                                <h5>${col}</h5>
                                <p>Sum: ${stats.sum.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                <p>Avg: ${stats.mean.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                <p>Min: ${stats.min.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                <p>Max: ${stats.max.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                            </div>
                        `;
                    }
                    resultHtml += '</div>';
                }
            } else if (result.type === 'scalar') {
                resultHtml += `
                    <div class="scalar-result">
                        <div class="scalar-value">${result.formatted_value}</div>
                    </div>
                `;
            }

            document.getElementById('finalResults').innerHTML = resultHtml;

            // Scroll to results
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function clearResults() {
            document.getElementById('queryInput').value = '';
            document.getElementById('resultsSection').style.display = 'none';
        }
    </script>
</body>
</html>